<div class="max-w-2xl mx-auto py-6">
  <div class="sm:flex sm:items-center sm:justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-white">Notifications</h1>
      <p class="mt-2 text-sm text-gray-400">Stay updated with your latest activities</p>
    </div>
    <% if @grouped_notifications.any? %>
      <%= link_to mark_all_as_read_notifications_path, method: :patch, 
                  class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",
                  data: { turbo_method: :patch } do %>
        Mark All as Read
      <% end %>
    <% end %>
  </div>

  <div class="space-y-4">
    <% if @grouped_notifications.any? %>
      <% @grouped_notifications.each do |group| %>
        <% notification = group[:latest_notification] %>
        <% notifications_in_group = group[:notifications] %>
        <% count = group[:count] %>
        
        <div class="bg-black border border-gray-800 rounded-xl p-4 <%= 'bg-gray-950' if notifications_in_group.any?(&:unread?) %>">
          <div class="flex items-start space-x-4">
            <!-- User Profile Pictures or Icons -->
            <div class="flex-shrink-0">
              <% if count > 1 %>
                <!-- Multiple users - show stacked profile pictures -->
                <div class="relative" style="width: 40px; height: 32px;">
                  <% notifications_in_group.first(3).each_with_index do |notif, index| %>
                    <% 
                      # Her bildirim için kullanıcıyı belirle
                      notif_user = case notif.notifiable_type
                      when 'Post'
                        if notif.notifiable.is_a?(Post) && notif.notifiable.user
                          notif.notifiable.user
                        elsif notif.notifiable.respond_to?(:user) && notif.notifiable.user
                          notif.notifiable.user
                        else
                          username = notif.message.split(' ').first
                          User.find_by(username: username)
                        end
                      when 'Message'
                        notif.notifiable.user if notif.notifiable.respond_to?(:user)
                      when 'Follow'
                        notif.notifiable.follower if notif.notifiable.respond_to?(:follower)
                      else
                        username = notif.message.split(' ').first
                        User.find_by(username: username)
                      end
                    %>
                    
                    <% if notif_user %>
                      <div class="absolute" style="left: <%= index * 8 %>px; z-index: <%= 10 - index %>;">
                        <%= link_to user_profile_path(notif_user.username), class: "block" do %>
                          <% if notif_user.profile_picture.attached? %>
                            <%= image_tag url_for(notif_user.profile_picture), class: "w-8 h-8 rounded-full object-cover border-2 border-black" %>
                          <% else %>
                            <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-white text-xs font-bold border-2 border-black">
                              <%= notif_user.username.first.upcase %>
                            </div>
                          <% end %>
                        <% end %>
                      </div>
                    <% end %>
                  <% end %>
                  
                  <!-- Count indicator for more than 3 users -->
                  <% if count > 3 %>
                    <div class="absolute" style="left: 24px; z-index: 1;">
                      <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-white text-xs font-bold border-2 border-black">
                        +<%= count - 3 %>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <!-- Single user - show single profile picture -->
                <% 
                  notification_user = case notification.notifiable_type
                  when 'Post'
                    if notification.notifiable.is_a?(Post) && notification.notifiable.user
                      notification.notifiable.user
                    elsif notification.notifiable.respond_to?(:user) && notification.notifiable.user
                      notification.notifiable.user
                    else
                      username = notification.message.split(' ').first
                      User.find_by(username: username)
                    end
                  when 'Message'
                    notification.notifiable.user if notification.notifiable.respond_to?(:user)
                  when 'Follow'
                    notification.notifiable.follower if notification.notifiable.respond_to?(:follower)
                  else
                    username = notification.message.split(' ').first
                    User.find_by(username: username)
                  end
                %>
                
                <% if notification_user %>
                  <%= link_to user_profile_path(notification_user.username), class: "block" do %>
                    <% if notification_user.profile_picture.attached? %>
                      <%= image_tag url_for(notification_user.profile_picture), class: "w-10 h-10 rounded-full object-cover" %>
                    <% else %>
                      <div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center text-white font-bold">
                        <%= notification_user.username.first.upcase %>
                      </div>
                    <% end %>
                  <% end %>
                <% else %>
                  <!-- Fallback: Notification Icon -->
                  <% case group[:notification_type] %>
                  <% when 'like' %>
                    <div class="w-10 h-10 rounded-full bg-red-600 flex items-center justify-center">
                      <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                      </svg>
                    </div>
                  <% when 'reply' %>
                    <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center">
                      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                      </svg>
                    </div>
                  <% when 'repost' %>
                    <div class="w-10 h-10 rounded-full bg-green-600 flex items-center justify-center">
                      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                      </svg>
                    </div>
                  <% when 'follow' %>
                    <div class="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center">
                      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                      </svg>
                    </div>
                  <% else %>
                    <div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center">
                      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM4.868 19.718A10.97 10.97 0 0112 22a10.97 10.97 0 717.132-2.282M4.868 19.718A10.97 10.97 0 714 12a8 8 0 1116 0 10.97 10.97 0 01-.868 7.718"/>
                      </svg>
                    </div>
                  <% end %>
                <% end %>
              <% end %>
            </div>

            <!-- Notification Content -->
            <div class="flex-1">
              <% 
                # Gruplanan mesajı oluştur
                if count > 1
                  # Kullanıcı adlarını topla
                  usernames = notifications_in_group.map do |notif|
                    case notif.notifiable_type
                    when 'Post'
                      if notif.notifiable.is_a?(Post) && notif.notifiable.user
                        notif.notifiable.user.username
                      elsif notif.notifiable.respond_to?(:user) && notif.notifiable.user
                        notif.notifiable.user.username
                      else
                        notif.message.split(' ').first
                      end
                    when 'Message'
                      notif.notifiable.user.username if notif.notifiable.respond_to?(:user)
                    when 'Follow'
                      notif.notifiable.follower.username if notif.notifiable.respond_to?(:follower)
                    else
                      notif.message.split(' ').first
                    end
                  end.compact.uniq
                  
                  # Mesajı oluştur
                  if usernames.length <= 3
                    user_list = usernames.join(', ')
                  else
                    user_list = "#{usernames.first(2).join(', ')} and #{usernames.length - 2} others"
                  end
                  
                  action_text = case group[:notification_type]
                  when 'like'
                    'liked your post'
                  when 'reply'
                    'replied to your post'
                  when 'repost'
                    'reposted your post'
                  when 'mention'
                    'mentioned you in a post'
                  when 'quote'
                    'quoted your post'
                  when 'follow'
                    'started following you'
                  else
                    'interacted with your content'
                  end
                  
                  grouped_message = "#{user_list} #{action_text}"
                else
                  grouped_message = notification.message
                end
              %>
              
              <% if group[:notification_type] == 'follow' %>
                <!-- Follow notifications - link to current user's followers page -->
                <%= link_to user_followers_path(Current.user.username), class: "block hover:bg-gray-900 rounded-lg p-2 -m-2 transition-colors" do %>
                  <div class="flex items-center justify-between">
                    <p class="text-sm text-white">
                      <%= grouped_message %>
                    </p>
                    <% if notifications_in_group.any?(&:unread?) %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        New
                      </span>
                    <% end %>
                  </div>
                  <p class="text-xs text-gray-400 mt-1">
                    <%= time_ago_in_words(notification.created_at) %> ago
                  </p>
                <% end %>
              <% elsif group[:post_id] %>
                <!-- Post-related notifications -->
                <%= link_to post_path(group[:post_id]), class: "block hover:bg-gray-900 rounded-lg p-2 -m-2 transition-colors" do %>
                  <div class="flex items-center justify-between">
                    <p class="text-sm text-white">
                      <%= grouped_message %>
                    </p>
                    <% if notifications_in_group.any?(&:unread?) %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        New
                      </span>
                    <% end %>
                  </div>
                  <% if group[:post_summary].present? %>
                    <div class="mt-2 p-2 bg-gray-900 rounded-lg border-l-2 border-blue-500">
                      <p class="text-xs text-gray-300 italic">
                        "<%= group[:post_summary] %>"
                      </p>
                    </div>
                  <% end %>
                  <p class="text-xs text-gray-400 mt-1">
                    <%= time_ago_in_words(notification.created_at) %> ago
                  </p>
                <% end %>
              <% else %>
                <!-- Fallback for other notifications -->
                <div class="block p-2 -m-2">
                  <div class="flex items-center justify-between">
                    <p class="text-sm text-white">
                      <%= grouped_message %>
                    </p>
                    <% if notifications_in_group.any?(&:unread?) %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        New
                      </span>
                    <% end %>
                  </div>
                  <p class="text-xs text-gray-400 mt-1">
                    <%= time_ago_in_words(notification.created_at) %> ago
                  </p>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Pagination -->
      <div class="mt-8">
        <% if @total_pages > 1 %>
          <div class="flex justify-center space-x-2">
            <% if @current_page > 1 %>
              <%= link_to "← Previous", notifications_path(page: @current_page - 1), 
                          class: "px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700" %>
            <% end %>
            
            <span class="px-4 py-2 bg-blue-600 text-white rounded-lg">
              Page <%= @current_page %> of <%= @total_pages %>
            </span>
            
            <% if @current_page < @total_pages %>
              <%= link_to "Next →", notifications_path(page: @current_page + 1), 
                          class: "px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700" %>
            <% end %>
          </div>
        <% end %>
      </div>
    <% else %>
      <!-- Empty State -->
      <div class="text-center py-12">
        <div class="w-16 h-16 mx-auto mb-4 bg-gray-800 rounded-full flex items-center justify-center">
          <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM4.868 19.718A10.97 10.97 0 0112 22a10.97 10.97 0 717.132-2.282M4.868 19.718A10.97 10.97 0 714 12a8 8 0 1116 0 10.97 10.97 0 01-.868 7.718"/>
          </svg>
        </div>
        <h3 class="text-lg font-medium text-white mb-2">No notifications yet</h3>
        <p class="text-gray-400">When you get notifications, they'll show up here.</p>
      </div>
    <% end %>
  </div>
</div>