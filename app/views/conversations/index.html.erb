<div class="max-w-2xl mx-auto py-6">
  <div class="sm:flex sm:items-center sm:justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-white">Messages</h1>
      <p class="mt-2 text-sm text-gray-400">Your conversations with other fans</p>
    </div>
    <div class="mt-4 sm:mt-0">
      <%= link_to "New Conversation", new_conversation_path, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
    </div>
  </div>

  <% if @conversations.any? %>
    <div class="space-y-1">
      <% @conversations.each do |conversation| %>
        <div id="conversation_<%= conversation.id %>" class="bg-black border border-gray-800 rounded-xl p-4 hover:bg-gray-950 transition-colors relative">
          <!-- Conversation Content -->
          <div class="flex items-start space-x-3">
            <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg flex-shrink-0 relative z-10 overflow-hidden">
              <%= link_to conversation_path(conversation), class: "absolute inset-0 flex items-center justify-center", data: { turbo_frame: "_top" } do %>
                <div class="w-full h-full bg-indigo-500 flex items-center justify-center">
                  <%= conversation.display_title(Current.user).first.upcase %>
                </div>
              <% end %>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between mb-1 relative z-10">
                <div class="flex items-center space-x-2">
                  <%= link_to conversation_path(conversation), class: "text-white font-semibold hover:underline", data: { turbo_frame: "_top" } do %>
                    <%= conversation.display_title(Current.user) %>
                  <% end %>
                  <% if conversation.unread_count_for(Current.user) > 0 %>
                     <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-600 text-white">
                       <%= conversation.unread_count_for(Current.user) %>
                     </span>
                   <% end %>
                </div>
                
                <!-- Dropdown Menu -->
                <div class="relative">
                  <button type="button" onclick="event.stopPropagation(); toggleDropdown('conversation-options-<%= conversation.id %>')"
                          class="text-gray-400 hover:text-white p-2 rounded-full hover:bg-gray-800 transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                    </svg>
                  </button>
                  
                  <!-- Dropdown Menu -->
                 <div id="conversation-options-<%= conversation.id %>" class="hidden absolute right-0 top-full mt-2 w-48 bg-gray-900 rounded-xl shadow-2xl border border-gray-700 z-50">
                    <div class="py-2">
                      <% if conversation.users.include?(Current.user) %>
                        <%= link_to conversation_path(conversation), method: :delete,
                            data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this conversation?" },
                            class: "block px-4 py-3 text-sm text-red-400 hover:bg-gray-800 flex items-center transition-colors" do %>
                          <span class="mr-3 text-lg">üóëÔ∏è</span>
                          Delete
                        <% end %>
                      <% end %>
                      
                      <%= link_to new_report_path(reportable_type: "Conversation", reportable_id: conversation.id), 
                          data: { turbo_frame: "modal" },
                          class: "block px-4 py-3 text-sm text-white hover:bg-gray-800 flex items-center transition-colors" do %>
                        <span class="mr-3 text-lg">üö©</span>
                        Report
                      <% end %>
                      
                      <% other_user = conversation.other_participants(Current.user).first %>
                      <% if other_user %>
                        <% unless Current.user.blocked_users.include?(other_user) %>
                          <%= link_to blocks_path, 
                              method: :post,
                              params: { blocked_user_id: other_user.id },
                              data: { turbo_method: :post, turbo_stream: true, turbo_confirm: "Block @#{other_user.username}?" },
                              class: "block px-4 py-3 text-sm text-white hover:bg-gray-800 flex items-center transition-colors" do %>
                            <span class="mr-3 text-lg">üö´</span>
                            Block @<%= other_user.username %>
                          <% end %>
                        <% else %>
                          <%= link_to user_block_path(other_user, Current.user.user_blocks.find_by(blocked_id: other_user.id)), 
                              method: :delete,
                              data: { turbo_method: :delete, turbo_stream: true, turbo_confirm: "Unblock @#{other_user.username}?" },
                              class: "block px-4 py-3 text-sm text-white hover:bg-gray-800 flex items-center transition-colors" do %>
                            <span class="mr-3 text-lg">‚úÖ</span>
                            Unblock @<%= other_user.username %>
                          <% end %>
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="text-sm text-gray-400 mb-1">
                 <%= time_ago_in_words(conversation.last_message&.created_at || conversation.created_at) %> ago
               </div>
               
               <% if conversation.last_message %>
                 <div class="text-sm text-gray-300 truncate">
                   <span class="font-medium"><%= conversation.last_message.user.username %>:</span>
                   <%= conversation.last_message.content.truncate(50) %>
                 </div>
               <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="text-center py-12 bg-black border border-gray-800 rounded-xl">
      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
      </svg>
      <h3 class="mt-2 text-sm font-medium text-white">No conversations</h3>
      <p class="mt-1 text-sm text-gray-400">Get started by creating a new conversation.</p>
      <div class="mt-6">
        <%= link_to "New Conversation", new_conversation_path, class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
      </div>
    </div>
  <% end %>
</div>