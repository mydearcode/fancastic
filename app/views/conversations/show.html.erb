<div class="max-w-4xl mx-auto px-4 py-6">
  <!-- Header -->
  <div class="bg-gray-900 shadow sm:rounded-lg mb-6 border border-gray-800">
    <div class="px-4 py-5 sm:p-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-xl font-semibold text-white">
            <%= @conversation.display_title(Current.user) %>
          </h1>
          <p class="mt-1 text-sm text-gray-400">
            <%= pluralize(@conversation.users.count, 'participant') %>
            <% if @conversation.last_message_at %>
              • Last message <%= time_ago_in_words(@conversation.last_message_at) %> ago
            <% end %>
          </p>
        </div>
        <div class="flex space-x-3">
          <%= link_to "← Back to Messages", conversations_path, class: "inline-flex items-center px-3 py-2 border border-gray-700 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-300 bg-gray-800 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
          <%= link_to "Leave Conversation", conversation_path(@conversation), method: :delete, 
              confirm: "Are you sure you want to leave this conversation?", 
              class: "inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Messages -->
  <div class="bg-gray-900 shadow sm:rounded-lg mb-6 border border-gray-800">
    <div class="px-4 py-5 sm:p-6">
      <% if @messages.any? %>
        <div class="space-y-4 max-h-96 overflow-y-auto" id="messages-container">          <% @messages.each do |message| %>
            <div class="flex <%= 'justify-end' if message.user == Current.user %>">
              <div class="flex max-w-xs lg:max-w-md <%= 'flex-row-reverse' if message.user == Current.user %>">
                <div class="flex-shrink-0 <%= 'ml-3' if message.user == Current.user %> <%= 'mr-3' unless message.user == Current.user %>">
                  <%= link_to user_profile_path(message.user.username), class: "block", data: { turbo_frame: "_top" } do %>
                    <div class="h-8 w-8 rounded-full overflow-hidden">
                      <% if message.user.profile_picture.attached? %>
                        <%= image_tag url_for(message.user.profile_picture), class: "w-full h-full object-cover" %>
                      <% else %>
                        <div class="w-full h-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
                          <span class="text-xs font-medium text-white">
                            <%= message.user.username.first.upcase %>
                          </span>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
                <div class="<%= 'bg-indigo-600 text-white' if message.user == Current.user %> <%= 'bg-gray-800 text-white' unless message.user == Current.user %> rounded-lg px-4 py-2">
                  <% unless message.user == Current.user %>
                    <p class="text-xs font-medium text-gray-400 mb-1"><%= message.user.username %></p>
                  <% end %>
                  <p class="text-sm"><%= simple_format(message.content) %></p>
                  <div class="flex items-center justify-between mt-2">
                    <p class="text-xs <%= 'text-indigo-200' if message.user == Current.user %> <%= 'text-gray-400' unless message.user == Current.user %>">
                      <%= message.created_at.strftime("%b %d, %I:%M %p") %>
                    </p>
                    <% if message.user == Current.user %>
                      <%= link_to "Delete", conversation_message_path(@conversation, message), 
                          method: :delete, 
                          confirm: "Are you sure?", 
                          class: "text-xs text-indigo-200 hover:text-white ml-2" %>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-8">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          <h3 class="mt-2 text-sm font-medium text-white">No messages yet</h3>
          <p class="mt-1 text-sm text-gray-400">Send the first message to get the conversation started.</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Message Form -->
  <div class="bg-gray-900 shadow sm:rounded-lg border border-gray-800">
    <div class="px-4 py-5 sm:p-6">
      <%= form_with model: [@conversation, @message], local: true, class: "space-y-4" do |form| %>
        <% if @message.errors.any? %>
          <div class="rounded-md bg-red-50 p-4">
            <div class="flex">
              <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">
                  There were <%= pluralize(@message.errors.count, "error") %> with your message:
                </h3>
                <div class="mt-2 text-sm text-red-700">
                  <ul class="list-disc pl-5 space-y-1">
                    <% @message.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        <% end %>
        
        <div>
          <%= form.label :content, "Your Message", class: "block text-sm font-medium text-white" %>
          <%= form.text_area :content, rows: 3, placeholder: "Type your message here...", class: "mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-700 rounded-md bg-gray-800 text-white" %>
        </div>
        
        <div class="flex justify-end">
          <%= form.submit "Send Message", class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  // Auto-scroll to bottom of messages
  document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.getElementById('messages-container');
    if (messagesContainer) {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
  });
</script>