<div id="post_<%= post.id %>" class="bg-white rounded-lg shadow-md p-6 mb-6">
  <!-- Post Header -->
  <div class="flex items-center mb-4">
    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold mr-3">
      <%= post.user.username.first.upcase %>
    </div>
    <div>
      <%= link_to user_profile_path(post.user), class: "font-semibold text-gray-900 hover:text-blue-600 transition-colors" do %>
        @<%= post.user.username %>
      <% end %>
      <p class="text-sm text-gray-500"><%= time_ago_in_words(post.created_at) %> ago</p>
    </div>
    <div class="ml-auto">
      <span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded-full">
        <%= post.visibility.humanize %>
      </span>
    </div>
  </div>

  <!-- Post Content -->
  <div class="mb-4">
    <% if post.repost_of_post_id.present? && post.text.blank? %>
      <!-- Pure Repost -->
      <div class="text-gray-600 mb-2">
        <i class="fas fa-retweet"></i> Reposted
      </div>
      <div class="border-l-4 border-gray-300 pl-4">
        <% if post.repost_of_post.quote_of_post_id.present? %>
          <!-- Reposted Quote Post -->
          <p class="text-gray-900 mb-4"><%= post.repost_of_post.text %></p>
          <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
            <p class="text-gray-700"><%= post.repost_of_post.quote_of_post.text %></p>
            <p class="text-sm text-gray-500 mt-2"><%= link_to "@#{post.repost_of_post.quote_of_post.user.username}", user_profile_path(post.repost_of_post.quote_of_post.user), class: "text-blue-600 hover:text-blue-800" %></p>
          </div>
        <% else %>
          <!-- Regular Repost -->
          <p class="text-gray-900"><%= post.repost_of_post.text %></p>
        <% end %>
        <p class="text-sm text-gray-500 mt-2">Originally by <%= link_to "@#{post.repost_of_post.user.username}", user_profile_path(post.repost_of_post.user), class: "text-blue-600 hover:text-blue-800" %></p>
      </div>
      <% # Set the target post for interactions to be the original post %>
      <% target_post = post.repost_of_post %>
    <% elsif post.quote_of_post_id.present? %>
      <!-- Quote Post -->
      <p class="text-gray-900 mb-4"><%= post.text %></p>
      <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
        <p class="text-gray-700"><%= post.quote_of_post.text %></p>
        <p class="text-sm text-gray-500 mt-2"><%= link_to "@#{post.quote_of_post.user.username}", user_profile_path(post.quote_of_post.user), class: "text-blue-600 hover:text-blue-800" %></p>
      </div>
      <% # For quote posts, target is the post itself %>
      <% target_post = post %>
    <% elsif post.in_reply_to_post_id.present? %>
      <!-- Reply -->
      <div class="text-gray-600 mb-2">
        <i class="fas fa-reply"></i> Replying to <%= link_to "@#{post.in_reply_to_post.user.username}", user_profile_path(post.in_reply_to_post.user), class: "text-blue-600 hover:text-blue-800" %>
      </div>
      <p class="text-gray-900"><%= post.text %></p>
      <% # For reply posts, target is the post itself %>
      <% target_post = post %>
    <% else %>
      <!-- Regular Post -->
      <p class="text-gray-900"><%= post.text %></p>
      <% # For regular posts, target is the post itself %>
      <% target_post = post %>
    <% end %>

    <% if post.image_url.present? %>
      <img src="<%= post.image_url %>" alt="Post image" class="mt-4 rounded-lg max-w-full h-auto">
    <% end %>
  </div>

  <!-- Post Actions -->
  <div class="flex justify-between items-center pt-4 border-t border-gray-100">
    <div class="flex space-x-6 text-sm text-gray-500">
      <!-- Reply -->
      <% if Current.user.can_perform_action?('reply') %>
        <%= link_to reply_post_path(target_post), class: "hover:text-blue-500 transition-colors flex items-center space-x-1",
            title: "Reply (-3 energy)" do %>
          <span>üí¨</span>
          <span><%= target_post.replies_count %></span>
        <% end %>
      <% else %>
        <span class="text-gray-400 cursor-not-allowed flex items-center space-x-1" title="Not enough energy to reply">
          <span>üí¨</span>
          <span><%= target_post.replies_count %></span>
        </span>
      <% end %>
      
      <!-- Repost -->
      <% if Current.user.can_perform_action?('repost') %>
        <%= link_to repost_post_path(target_post), method: :post, 
            data: { turbo_method: :post, turbo_confirm: target_post.reposted_by?(Current.user) ? "Remove your repost?" : "Repost this to your followers?" }, 
            class: "hover:text-green-500 transition-colors flex items-center space-x-1 #{'text-green-500' if target_post.reposted_by?(Current.user)}",
            title: target_post.reposted_by?(Current.user) ? "Remove repost (-2 energy)" : "Repost (-2 energy)" do %>
          <span>üîÑ</span>
          <span><%= target_post.reposts_count %></span>
        <% end %>
      <% else %>
        <span class="text-gray-400 cursor-not-allowed flex items-center space-x-1" title="Not enough energy to repost">
          <span>üîÑ</span>
          <span><%= target_post.reposts_count %></span>
        </span>
      <% end %>
      
      <!-- Like -->
      <% if Current.user.can_perform_action?('like') %>
        <%= link_to like_post_path(target_post), method: :post, 
            data: { turbo_method: :post }, 
            class: "hover:text-red-500 transition-colors flex items-center space-x-1 #{'text-red-500' if target_post.liked_by?(Current.user)}",
            title: target_post.liked_by?(Current.user) ? "Unlike (-1 energy)" : "Like (-1 energy)" do %>
          <span><%= target_post.liked_by?(Current.user) ? '‚ù§Ô∏è' : 'ü§ç' %></span>
          <span><%= target_post.likes_count %></span>
        <% end %>
      <% else %>
        <span class="text-gray-400 cursor-not-allowed flex items-center space-x-1" title="Not enough energy to like">
          <span>ü§ç</span>
          <span><%= target_post.likes_count %></span>
        </span>
      <% end %>
      
      <!-- Quote -->
      <% if Current.user.can_perform_action?('quote') %>
        <%= link_to quote_post_path(target_post), 
            class: "hover:text-purple-500 transition-colors flex items-center space-x-1",
            title: "Quote (-3 energy)",
            data: { turbo_frame: "quote_modal" } do %>
          <span>üí≠</span>
          <span><%= target_post.quotes_count %></span>
        <% end %>
      <% else %>
        <span class="text-gray-400 cursor-not-allowed flex items-center space-x-1" title="Not enough energy to quote">
          <span>üí≠</span>
          <span><%= target_post.quotes_count %></span>
        </span>
      <% end %>
    </div>
  </div>
</div>